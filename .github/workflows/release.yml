name: Release Build and Deploy

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # åªæœ‰æ¨™ç±¤æ¨é€æ™‚æ‰å‰µå»ºGitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false
        continue-on-error: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          yes | sdkmanager --licenses
          sdkmanager --install "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Grant Gradle permissions
        run: chmod +x gradlew

      - name: Decode Android keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Compute version
        shell: bash
        run: |
          echo "æ­£åœ¨è¨ˆç®—ç™¼å¸ƒç‰ˆæœ¬è™Ÿ..."
          TAG="$(git describe --tags --abbrev=0)"
          VERSION_NAME="${TAG#v}"
          # Ensure version code is greater than 24
          VERSION_CODE=$((GITHUB_RUN_NUMBER + 25))
          echo "ç™¼å¸ƒç‰ˆæœ¬åç¨±: $VERSION_NAME"
          echo "ç‰ˆæœ¬ä»£ç¢¼: $VERSION_CODE (base: ${GITHUB_RUN_NUMBER} + 25)"
          echo "WM_VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "WM_VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV

      - name: Build release bundles and APK
        env:
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/keystore.jks
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "é–‹å§‹æ§‹å»ºç™¼å¸ƒç‰ˆæœ¬..."
          ./gradlew -PwmVersionName=${{ env.WM_VERSION_NAME }} -PwmVersionCode=${{ env.WM_VERSION_CODE }} \
            :app:bundleRelease :app:assembleRelease \
            --stacktrace --no-daemon
          echo "æ§‹å»ºå®Œæˆ"

      - name: Compute checksums
        run: |
          set -e
          cd app
          echo "æ­£åœ¨ç”Ÿæˆ SHA256 æ ¡é©—ç¢¼..."
          sha256sum build/outputs/bundle/release/*.aab > SHA256SUMS.txt
          sha256sum build/outputs/apk/release/*.apk >> SHA256SUMS.txt
          if [ -f build/outputs/mapping/release/mapping.txt ]; then
            sha256sum build/outputs/mapping/release/mapping.txt >> SHA256SUMS.txt
          fi
          echo "æ ¡é©—ç¢¼ç”Ÿæˆå®Œæˆ:"
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.1.0
        with:
          tag_name: ${{ github.ref_name }}
          name: v${{ env.WM_VERSION_NAME }}
          draft: false
          prerelease: false
          files: |
            app/build/outputs/bundle/release/*.aab
            app/build/outputs/apk/release/*.apk
            app/build/outputs/mapping/release/mapping.txt
            app/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  internal_test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # åªæœ‰mainåˆ†æ”¯æ¨é€æ™‚æ‰éƒ¨ç½²åˆ°Internal Test
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false
        continue-on-error: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          yes | sdkmanager --licenses
          sdkmanager --install "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Grant Gradle permissions
        run: chmod +x gradlew

      - name: Decode Android keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Compute version for internal test
        shell: bash
        run: |
          echo "æ­£åœ¨è¨ˆç®—å…§éƒ¨æ¸¬è©¦ç‰ˆæœ¬è™Ÿ..."
          VERSION_NAME="1.8.0-internal"
          # Ensure version code is greater than 24
          VERSION_CODE=$((GITHUB_RUN_NUMBER + 25))
          echo "å…§éƒ¨æ¸¬è©¦ç‰ˆæœ¬åç¨±: $VERSION_NAME"
          echo "ç‰ˆæœ¬ä»£ç¢¼: $VERSION_CODE (base: ${GITHUB_RUN_NUMBER} + 25)"
          echo "WM_VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "WM_VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV

      - name: Build release bundle for internal test
        env:
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/keystore.jks
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "é–‹å§‹æ§‹å»ºå…§éƒ¨æ¸¬è©¦ç‰ˆæœ¬..."
          ./gradlew -PwmVersionName=${{ env.WM_VERSION_NAME }} -PwmVersionCode=${{ env.WM_VERSION_CODE }} \
            :app:bundleRelease \
            --stacktrace --no-daemon
          echo "æ§‹å»ºå®Œæˆ"

      - name: Verify AAB file exists before upload
        run: |
          echo "æª¢æŸ¥ AAB æª”æ¡ˆæ˜¯å¦å­˜åœ¨..."
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            echo "âœ… AAB æª”æ¡ˆå­˜åœ¨: app/build/outputs/bundle/release/app-release.aab"
            ls -la app/build/outputs/bundle/release/app-release.aab
          else
            echo "âŒ AAB æª”æ¡ˆä¸å­˜åœ¨: app/build/outputs/bundle/release/app-release.aab"
            echo "å¯ç”¨çš„æª”æ¡ˆ:"
            ls -la app/build/outputs/bundle/release/ || echo "ç›®éŒ„ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Install jq for JSON validation
        run: |
          echo "å®‰è£ jq å·¥å…·..."
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Check Google Play service account configuration
        run: |
          echo "æª¢æŸ¥ Google Play æœå‹™å¸³æˆ¶é…ç½®..."
          if [ -z "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}" ]; then
            echo "âŒ PLAY_SERVICE_ACCOUNT_JSON secret æœªè¨­å®š"
            echo "è«‹åœ¨ GitHub repository settings > Secrets and variables > Actions ä¸­è¨­å®šæ­¤ secret"
            exit 1
          else
            echo "âœ… PLAY_SERVICE_ACCOUNT_JSON secret å·²è¨­å®š"
            # é©—è­‰ JSON æ ¼å¼
            echo "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}" | jq . > /dev/null 2>&1
            if [ $? -eq 0 ]; then
              echo "âœ… JSON æ ¼å¼æœ‰æ•ˆ"
              # æª¢æŸ¥å¿…è¦çš„æ¬„ä½
              if echo "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}" | jq -e '.type' > /dev/null 2>&1; then
                echo "âœ… æœå‹™å¸³æˆ¶é¡å‹æ¬„ä½å­˜åœ¨"
              else
                echo "âŒ æœå‹™å¸³æˆ¶é¡å‹æ¬„ä½ç¼ºå¤±"
                exit 1
              fi
            else
              echo "âŒ JSON æ ¼å¼ç„¡æ•ˆ"
              echo "è«‹æª¢æŸ¥ PLAY_SERVICE_ACCOUNT_JSON secret çš„æ ¼å¼æ˜¯å¦æ­£ç¢º"
              exit 1
            fi
          fi

      - name: Upload AAB to Google Play Internal Test
        id: upload_play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.wealthmanager
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
        continue-on-error: true

      - name: Check upload result
        run: |
          echo "æª¢æŸ¥ä¸Šå‚³çµæœ..."
          if [ "${{ steps.upload_play.outcome }}" = "success" ]; then
            echo "âœ… Google Play Internal Test ä¸Šå‚³æˆåŠŸ"
            echo "ç‰ˆæœ¬åç¨±: ${{ env.WM_VERSION_NAME }}"
            echo "ç‰ˆæœ¬ä»£ç¢¼: ${{ env.WM_VERSION_CODE }}"
            echo "è»Œé“: internal"
          else
            echo "âŒ Google Play Internal Test ä¸Šå‚³å¤±æ•—"
            echo "ä¸Šå‚³çµæœ: ${{ steps.upload_play.outcome }}"
            echo ""
            echo "å¯èƒ½çš„å¤±æ•—åŸå› :"
            echo "1. ğŸ” æœå‹™å¸³æˆ¶æ¬Šé™ä¸è¶³ - æª¢æŸ¥ Google Play Console ä¸­çš„æœå‹™å¸³æˆ¶æ¬Šé™"
            echo "2. ğŸ“¦ AAB æª”æ¡ˆæ ¼å¼å•é¡Œ - æª¢æŸ¥ AAB æ˜¯å¦æ­£ç¢ºæ§‹å»º"
            echo "3. ğŸ”¢ ç‰ˆæœ¬ä»£ç¢¼è¡çª - æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒç‰ˆæœ¬ä»£ç¢¼çš„ç™¼å¸ƒ"
            echo "4. ğŸŒ ç¶²è·¯é€£ç·šå•é¡Œ - æª¢æŸ¥ GitHub Actions ç¶²è·¯é€£ç·š"
            echo "5. âš™ï¸  Google Play Console è¨­å®šå•é¡Œ - æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼è¨­å®š"
            echo "6. ğŸ”‘ æœå‹™å¸³æˆ¶ JSON æ ¼å¼éŒ¯èª¤ - æª¢æŸ¥ secret è¨­å®š"
            echo "7. ğŸ“± æ‡‰ç”¨ç¨‹å¼åŒ…åä¸åŒ¹é… - æª¢æŸ¥ packageName è¨­å®š"
            echo ""
            echo "å»ºè­°çš„æª¢æŸ¥æ­¥é©Ÿ:"
            echo "1. æª¢æŸ¥ Google Play Console ä¸­çš„æ‡‰ç”¨ç¨‹å¼è¨­å®š"
            echo "2. ç¢ºèªæœå‹™å¸³æˆ¶æœ‰æ­£ç¢ºçš„æ¬Šé™"
            echo "3. æª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒç‰ˆæœ¬ä»£ç¢¼çš„ç™¼å¸ƒ"
            echo "4. é©—è­‰ AAB æª”æ¡ˆæ˜¯å¦æ­£ç¢ºç”Ÿæˆ"
            exit 1
          fi
